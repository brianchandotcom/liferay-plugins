<?xml version="1.0"?>
<!DOCTYPE project>

<project name="build-common-ivy" xmlns:ivy="antlib:org.apache.ivy.ant">
	<property name="ivy.home" value="${project.dir}/.ivy" />
	<property name="ivy.install.version" value="2.3.0" />

	<if>
		<not>
			<available file="${ivy.home}/ivy-${ivy.install.version}.jar" />
		</not>
		<then>
			<mkdir dir="${ivy.home}" />

			<get
				dest="${ivy.home}"
				src="http://repo2.maven.org/maven2/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar"
			/>
		</then>
	</if>

	<path id="ivy.lib.path">
		<fileset
			dir="${ivy.home}"
			includes="ivy-${ivy.install.version}.jar"
		/>
	</path>

	<taskdef classpathref="ivy.lib.path" resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" />

	<basename file="${project.dir}" property="projectdir.name" />

	<for list="${project.dir},${basedir}" param="ivy.xml.dir">
		<sequential>
			<var name="ivy.md5.dir" unset="true" />
			<var name="ivy.xml.updated" unset="true" />
			<var name="tstamp.value" unset="true" />

			<pathconvert property="ivy.md5.dir">
				<map from="${project.dir}" to="${ivy.home}/${projectdir.name}" />

				<path location="@{ivy.xml.dir}"/>
			</pathconvert>

			<if>
				<available file="@{ivy.xml.dir}/ivy.xml" />

				<then>
					<checksum file="@{ivy.xml.dir}/ivy.xml" todir="${ivy.md5.dir}" />

					<tstamp>
						<format offset="-1" pattern="yyyyMMddkkmmssSSS" property="tstamp.value" unit="second" />
					</tstamp>

					<condition property="ivy.xml.updated">
						<islastmodified datetime="${tstamp.value}" mode="after" pattern="yyyyMMddkkmmssSSS">
							<file file="${ivy.md5.dir}/ivy.xml.MD5" />
						</islastmodified>
					</condition>
				</then>
			</if>

			<if>
				<istrue value="${ivy.xml.updated}" />

				<then>
					<ivy:settings file="${project.dir}/ivy-settings.xml" />

					<ivy:resolve
						file="@{ivy.xml.dir}/ivy.xml"
						log="download-only"
					/>

					<if>
						<equals arg1="@{ivy.xml.dir}" arg2="${project.dir}" />

						<then>
							<ivy:retrieve
								log="download-only"
								pattern="@{ivy.xml.dir}/lib/[artifact].[ext]"
								type="jar"
							/>
						</then>
						<else>
							<ivy:retrieve
								log="download-only"
								pattern="@{ivy.xml.dir}/docroot/WEB-INF/lib/[artifact].[ext]"
								type="jar"
							/>
						</else>
					</if>
				</then>
			</if>
		</sequential>
	</for>
</project>